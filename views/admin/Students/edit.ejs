<%- include('../elements/header'); %>
<div class="main-content">
  <div class="main-content-inner">
    <div class="breadcrumbs ace-save-state" id="breadcrumbs">
      <ul class="breadcrumb">
        <li>
          <i class="ace-icon fa fa-tachometer"></i>
          <a href="<%=nodeAdminUrl%>/Dashboard">Dashboard </a>
        </li>
        <li class="active">
          <a href="<%=nodeAdminUrl%>/<%=controller%>/list"> Users </a>
        </li>
        <li class="active">edit</li>
      </ul>
      <!-- /.breadcrumb -->
      <div class="nav-search" id="nav-search">
        <form class="form-search">
          <span class="input-icon">
            <input
              type="text"
              placeholder="Search ..."
              class="nav-search-input"
              id="nav-search-input"
              autocomplete="off"
            />
            <i class="ace-icon fa fa-search nav-search-icon"></i>
          </span>
        </form>
      </div>
      <!-- /.nav-search -->
    </div>
    <div class="page-content">
      <div class="ace-settings-container" id="ace-settings-container">
        <div
          class="btn btn-app btn-xs btn-warning ace-settings-btn"
          id="ace-settings-btn"
        >
          <i class="ace-icon fa fa-cog bigger-130"></i>
        </div>
        <div class="ace-settings-box clearfix" id="ace-settings-box">
          <div class="pull-left width-50">
            <div class="ace-settings-item">
              <div class="pull-left">
                <select id="skin-colorpicker" class="hide">
                  <option data-skin="no-skin" value="#438EB9">#438EB9</option>
                  <option data-skin="skin-1" value="#222A2D">#222A2D</option>
                  <option data-skin="skin-2" value="#C6487E">#C6487E</option>
                  <option data-skin="skin-3" value="#D0D0D0">#D0D0D0</option>
                </select>
              </div>
              <span>&nbsp; Choose Skin</span>
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2 ace-save-state"
                id="ace-settings-navbar"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-navbar"> Fixed Navbar</label>
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2 ace-save-state"
                id="ace-settings-sidebar"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-sidebar">
                Fixed Sidebar</label
              >
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2 ace-save-state"
                id="ace-settings-breadcrumbs"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-breadcrumbs">
                Fixed Breadcrumbs</label
              >
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2"
                id="ace-settings-rtl"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-rtl">
                Right To Left (rtl)</label
              >
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2 ace-save-state"
                id="ace-settings-add-container"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-add-container">
                Inside <b>.container</b>
              </label>
            </div>
          </div>
          <!-- /.pull-left -->
          <div class="pull-left width-50">
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2"
                id="ace-settings-hover"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-hover">
                Submenu on Hover</label
              >
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2"
                id="ace-settings-compact"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-compact">
                Compact Sidebar</label
              >
            </div>
            <div class="ace-settings-item">
              <input
                type="checkbox"
                class="ace ace-checkbox-2"
                id="ace-settings-highlight"
                autocomplete="off"
              />
              <label class="lbl" for="ace-settings-highlight">
                Alt. Active Item</label
              >
            </div>
          </div>
          <!-- /.pull-left -->
        </div>
      </div>
      <div class="page-header">
        <h1>
          <%=controller%>
          <small>
            <i class="ace-icon fa fa-angle-double-right"></i> Edit
          </small>
        </h1>
      </div>
      <div class="row">
        <div class="col-xs-12 col-sm-6">
          <div class="">
            <form
              method="post"
              action="<%=nodeAdminUrl%>/<%=controller%>/edit/<%=data.id%>"
              enctype="multipart/form-data"
            >
              <div class="widget-body">
                <input type="hidden" value="" name="id" />
                <div class="widget-main">
                  <div class="form-group row">
                    <label
                      for="form-field-select-1"
                      class="col-sm-4 col-form-label"
                      >Name</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="text"
                        class="form-control"
                        id="form-field-select-1"
                        value=""
                        placeholder="Name"
                        name="first_name"
                      />
                      <span class="error"></span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-1"
                      class="col-sm-4 col-form-label"
                      >Phone number</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="number"
                        class="form-control"
                        id="form-field-select-1"
                        placeholder="Phone number"
                        value=""
                        name="contact_number"
                      />
                      <span class="error"> </span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-1"
                      class="col-sm-4 col-form-label"
                      >Address</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="text"
                        class="form-control"
                        id="form-field-select-1"
                        placeholder="Address"
                        value=""
                        name="address"
                      />
                      <span class="error"> </span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-1"
                      class="col-sm-4 col-form-label"
                    >
                      Profile Image
                    </label>
                    <div class="col-sm-8">
                      <input
                        type="file"
                        name="profile_pic"
                        id="form-field-select-1"
                        class="form-control"
                      />
                      <span class="error"> </span>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-4"></div>
                    <div class="col-md-8">
                      <img style="width: 150px" src="" id="student_img" />
                    </div>
                  </div>
                  <div class="form-group row" id="membership_type">
                    <label
                      for="form-field-select-2"
                      class="col-sm-4 col-form-label"
                      >Membership type</label
                    >
                    <div class="col-sm-8">
                      <select
                        class="form-control"
                        name="membershipType_id"
                        id="membershipType"
                        class="form-control"
                        onchange="membership_type(event)"
                      ></select>
                      <span class="error"
                        ><%=errorData.membershipType_id%>
                      </span>
                    </div>
                  </div>
                  <div class="form-group row" id="membership_type">
                    <label
                      for="form-field-select-2"
                      class="col-sm-4 col-form-label"
                      >Membership Options</label
                    >
                    <div class="col-sm-8">
                      <select
                        class="form-control"
                        name="membershipTypeOption_id"
                        id="membeshipTypeOption"
                        class="form-control"
                        onchange="membershipOption(event)"
                      ></select>
                      <span class="error"
                        ><%=errorData.membershipTypeOption_id%>
                      </span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-1"
                      class="col-sm-4 col-form-label"
                    >
                      Start Date
                    </label>
                    <div class="col-sm-4">
                      <input
                        type="date"
                        name="start_date"
                        id="form-field-select-1"
                        class="form-control"
                        value="<%=data.start_date %>"
                        onchange="CheckMembershipTypeOption()"
                      />
                      <span class="error"><%=errorData.start_date%> </span>
                    </div>
                    <div class="col-sm-4">
                      <div>
                        <label class="radio-inline">
                          <input type="radio" value="Lunch"
                          name="start_date_meal" onclick="getEndDate(event)"
                          <%=data.start_date_meal == 'Lunch' ? 'checked' : ''
                          %>>Lunch
                        </label>
                        <label class="radio-inline">
                          <input type="radio" value="Dinner"
                          name="start_date_meal" onclick="getEndDate(event)"
                          <%=data.start_date_meal == 'Dinner' ? 'checked' : ''
                          %>>Dinner
                        </label>
                      </div>
                      <span class="error"><%=errorData.start_date_meal%> </span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-1"
                      class="col-sm-4 col-form-label"
                    >
                      End Date
                    </label>
                    <div class="col-sm-4">
                      <input
                        type="date"
                        name="end_date"
                        id="form-field-select-1"
                        class="form-control"
                        value="<%=data.end_date %>"
                      />
                      <span class="error"><%=errorData.end_date%> </span>
                    </div>
                    <div class="col-sm-4">
                      <div>
                        <label class="radio-inline">
                          <input
                            type="radio"
                            value="Lunch"
                            name="end_date_meal"
                          />Lunch
                        </label>
                        <label class="radio-inline">
                          <input
                            type="radio"
                            value="Dinner"
                            name="end_date_meal"
                          />Dinner
                        </label>
                      </div>
                      <span class="error"><%=errorData.end_date_meal%> </span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-2"
                      class="col-sm-4 col-form-label"
                      >Payment</label
                    >
                    <div class="col-sm-8">
                      <div>
                        <label class="radio-inline">
                          <input type="radio" value="Cash" name="payment" />Cash
                        </label>
                        <label class="radio-inline">
                          <input
                            type="radio"
                            value="Online"
                            name="payment"
                          />Online
                        </label>
                      </div>
                      <span class="error"></span>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label for="form-field-select-2" class="col-sm-4 col-form-label">Amount</label>
                    <div class="col-sm-8">
                      <input type="number" class="form-control" name="amount">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-2"
                      class="col-sm-4 col-form-label"
                      >Location</label
                    >
                    <div class="col-sm-8">
                      <select class="form-control" name="location_id">
                        <option value="" disabled selected value="">
                          Select Location
                        </option>
                        <% for (var i = 0; i < All_locations.length; i++) { %>
                        <option value="<%= All_locations[i]._id %>">
                          <%= All_locations[i].name %>
                        </option>
                        <% } %>
                      </select>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-2"
                      class="col-sm-4 col-form-label"
                      >Remark</label
                    >
                    <div class="col-sm-8">
                      <textarea class="form-control" name="remark">
<%= data.remark %>
                                                                            </textarea
                      >
                    </div>
                  </div>
                  <div class="form-group row">
                    <label
                      for="form-field-select-2"
                      class="col-sm-4 col-form-label"
                      >Status</label
                    >
                    <div class="col-sm-8">
                      <select
                        class="form-control"
                        name="is_active"
                        id="form-field-select-2"
                      >
                        <option value="1">Active</option>
                        <option value="0">Inactive</option>
                      </select>
                      <span class="error"></span>
                    </div>
                  </div>
                  <div>
                    <div class="row">
                      <div class="col-md-offset-3 col-md-9">
                        <button class="btn btn-info" type="submit">
                          <i class="ace-icon fa fa-check bigger-110"></i> Submit
                        </button>
                        &nbsp; &nbsp; &nbsp;
                        <a href="<%=nodeAdminUrl%>/<%=controller%>/list%>">
                          <button class="btn" type="button">Cancel</button>
                        </a>
                      </div>
                    </div>
                    <div class="space-2"></div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
        <!-- /.span -->
      </div>
    </div>
    <!-- /.page-content -->
  </div>
</div>
<!-- /.main-content -->
<script>
  var siteUrl = "<%=nodeSiteUrl%>";
  function getStudent() {
    const url = window.location.href;
    const segments = url.split("/");
    const id = segments[segments.length - 1];
    $.ajax({
      url: `/admin/Students/get/${id}`,
      method: "get",
      success: function (data) {
        console.log(data);
        $("input[name='id']").val(data.data._id);
        $("input[name='first_name']").val(data.data.first_name);
        $("input[name='contact_number']").val(data.data.contact_number);
        $("input[name='address']").val(data.data.address);
        $("input[name='start_date']").val(data.data.start_date);
        $("input[name='end_date']").val(data.data.end_date);
        $("input[name='remark']").val(data.data.remark);
        if(data.data.payHistory.length > 0){
         $("input[name='amount']").val(data.data.payHistory[data.data.payHistory.length - 1].amount);
        }
        if (data.data.profile_pic) {
          $("#student_img").attr(
            "src",
            `${siteUrl}/upload/${data.data.profile_pic}`
          );
        } else {
          $("#student_img").attr(
            "src",
            `${siteUrl}/images/No_Image_Available.png`
          );
        }
        $("select[name='is_active']")
          .val(data.data.is_active)
          .prop("selected", true);
        if (data.data.start_date_meal !== undefined) {
          $("input[name='start_date_meal']").each(function () {
            if ($(this).val() === data.data.start_date_meal) {
              $(this).prop("checked", true);
            } else {
              $(this).prop("checked", false);
            }
          });
        }
        if (data.data.end_date_meal !== undefined) {
          $("input[name='end_date_meal']").each(function () {
            if ($(this).val() === data.data.end_date_meal) {
              $(this).prop("checked", true);
            } else {
              $(this).prop("checked", false);
            }
          });
        }
        if (data.data.payment !== undefined) {
          const paymentValue = data.data.payment;
          $("input[name='payment']").each(function () {
            if ($(this).val() === paymentValue) {
              $(this).prop("checked", true);
            } else {
              $(this).prop("checked", false);
            }
          });
        }

        if (data.data.location_id != undefined) {
          $("select[name='location_id']")
            .val(data.data.location_id)
            .prop("selected", true);
        }
        $("select[name='membershipType_id']")
          .val(data.data.membershipType_id)
          .prop("selected", true);
        getMembershipTypeOptions(
          data.data.membershipType_id,
          data.data.membershipTypeOption_id
        );
      },
    });
  }
  getStudent();
  function getMembershipTye() {
    $("#membershipType").empty();
    $.ajax({
      url: `/api/membershipTypes`,
      method: "GET",
      success: function (data) {
        var html = `<option value="" selected disabled>Select membership type</option>`;
        data.data.map(function (element) {
          html += `<option value="${element._id}">${element.name}</option>`;
        });
        $("#membershipType").append(html);
      },
    });
  }
  getMembershipTye();
  function getMembershipTypeOptions(id, membershipTypeOption_id) {
    $.ajax({
      url: `/api/membershipTypeOptions/get/${id}`,
      method: "GET",
      success: function (data) {
        //console.log(data.data);
        var html = `<option value="">Select memebership type</option>`;
        data.data.map(function (element) {
          html += `<option value="${element._id}">${element.name}</option>`;
        });
        $("select[name='membershipTypeOption_id']").append(html);
        $("select[name='membershipTypeOption_id']")
          .val(membershipTypeOption_id)
          .prop("selected", true);
      },
    });
  }
  function membership_type(event) {
    $("#membeshipTypeOption").empty();
    $("input[name=start_date]").val("");
    $("input[name=end_date]").val("");
    $('input[name="start_date_meal"]').prop("checked", false);
    $('input[name="end_date_meal"]').prop("checked", false);
    $.ajax({
      url: `/api/membershipTypeOptions/get/${event.target.value}`,
      method: "GET",
      success: function (data) {
        var html = `<option value="" selected disabled>Select membership type option</option>`;
        data.data.map(function (element) {
          html += `<option value="${element._id}">${element.name}</option>`;
        });
        $("#membeshipTypeOption").append(html);
      },
    });
  }
  function getEndDate(event) {
    var meal = event.target.value;
    var start_date = $("input[name='start_date']").val();
    var type = $("select[name='membershipType_id']").val();
    var option = $("select[name='membershipTypeOption_id']").val();
    var formData = new FormData();
    formData.append("type", type);
    formData.append("option", option);
    formData.append("start_date", start_date);
    formData.append("meal", meal);
    $.ajax({
      url: `/admin/Students/endDate`,
      method: "POST",
      dataType: "json",
      data: formData,
      processData: false,
      contentType: false,
      success: function (data) {
        console.log(data.data);
        $("input[name='end_date']").val(data.data.endDate);
        $(`input[name="end_date_meal"][value="${data.data.meal}"]`).prop(
          "checked",
          true
        );
      },
    });
  }
  function membershipOption(event) {
    $("input[name=start_date]").val("");
    $("input[name=end_date]").val("");
    $('input[name="start_date_meal"]').prop("checked", false);
    $('input[name="end_date_meal"]').prop("checked", false);
  }
</script>
<%- include('../elements/footer'); %>
